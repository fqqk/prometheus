# setup prometheus

single start
```
docker-compose up
```

multi start
```
docker-compose -f docker-compose.yml up
```

stop
```
docker-compose down
```

access
http://localhost:9090/

参考：https://qiita.com/moaikids/items/7de6f071574a64290769

# モニタリング

> CPU利用時間を表示するクエリ（node_exporterを使用）: CPUが1コアあるサーバーにおいて、node_cpu_seconds_totalという項目名で保存されているCPU利用時間のメトリクスの、1分ごとの変動値を表示するクエリ
```
avg without(cpu) (rate(node_cpu_seconds_total{mode!="idle"}[1m]))
```
画像貼り付け

特にサイトに負荷がかかっていないためグラフが安定化している

> CPUのコアとは？

CPUの中で演算処理を行う実際の処理部のこと
- CPUには複数のコアが搭載されており、それぞれが独立して演算処理を実行できます。
- 1コアのCPUはシングルコア、2コアのCPUはデュアルコア、4コアのCPUはクアッドコアと呼ばれます。
  - コア数が多いほど同時に処理できる量が増え、マルチタスクのパフォーマンスが向上します。
  - 近年のCPUはマルチコア化が進み、8コア、16コアといった多コアCPUが主流です。
  - コアにはそれぞれCPUクロックの周波数が設定されており、このクロック数 × コア数がCPUの処理性能の指標となります。
  - OSはこの複数のコアを割り当てて、並行してプロセスを実行させることができます。
  - プログラムもマルチスレッド化することで、複数のコアに処理を分散させることができます。

このように、CPUのコアとは演算処理を行う実際の処理エンジンのことで、コア数によって同時実行能力が決まります。マルチコアCPUはパラレル処理を得意とします。

> マルチスレッド化とは

1つのプログラムを複数のスレッドに分割して並列処理を行うこと
- スレッドとは、プログラム内で独立して処理を実行できる単位です。
- マルチスレッド化することで、マルチコアのCPUを活用できるようになります。
- 各スレッドは共通のメモリ空間を参照するので、データの受け渡しが効率的です。
- スレッド間で処理をうまく分割することで、並列処理による速度向上が期待できます。

マルチスレッド化の利点
- プログラムの応答性が向上する
- CPUリソースを最大限活用できる
- ノンブロッキングな処理が実装しやすい

マルチスレッドのデメリット
- スレッド間でデータ競合が発生する可能性がある
- デバッグが難しくなることがある
- 意図せぬ副作用を引き起こすリスクがある

マルチスレッド設計時のポイント
- データ競合に注意する
- スレッドセーフなデータ構造を使う
- 排他制御を適切に行う
- スレッド間のデッドロックを防ぐ

マルチスレッドをうまく活用するには
- 扱うデータ構造
- 並列処理アルゴリズム
- 言語の並列処理機能
に関する知識が必要不可欠

rubyでも1.8系とかからThreadというクラスが導入されていて、古くからマルチスレッド処理は書ける

サイトに負荷をかけてみる([linux環境で試す](https://github.com/fqqk/linux-env))
```
$ stress -c 1
```
画像のように、一時的にグラフが跳ね上がっていることが見て取れる。

